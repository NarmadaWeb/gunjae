# Supabase Setup Instructions

To run the Gunjae application with Supabase, you need to set up a Supabase project and create the necessary tables.

## 1. Create a Supabase Project

Go to [Supabase](https://supabase.com/) and create a new project.

## 2. Get your URL and Anon Key

Once the project is created, go to Project Settings > API.
Copy the `Project URL` and `anon` public key.

Update `lib/main.dart` with these values:

```dart
await Supabase.initialize(
  url: 'YOUR_SUPABASE_URL',
  anonKey: 'YOUR_SUPABASE_ANON_KEY',
);
```

## 3. Create Tables (SQL Editor)

Run the following SQL in the Supabase SQL Editor to create the necessary tables and policies.

```sql
-- Create Spots Table
create table spots (
  id bigint generated by default as identity primary key,
  name text not null,
  location text not null,
  price numeric not null,
  rating numeric not null,
  "imageUrl" text not null,
  description text not null,
  facilities text not null -- Comma separated string for simplicity matching app logic
);

-- Create Profiles Table (to store user names)
create table profiles (
  id uuid references auth.users not null primary key,
  name text,
  email text,
  "avatarUrl" text
);

-- Trigger to create profile on signup
create or replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public.profiles (id, name, email)
  values (new.id, new.raw_user_meta_data->>'name', new.email);
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();


-- Create Bookings Table
create table bookings (
  id bigint generated by default as identity primary key,
  "userId" uuid references auth.users not null,
  "spotId" bigint references spots(id) not null,
  "checkIn" timestamp with time zone not null,
  "checkOut" timestamp with time zone not null,
  guests int not null,
  "totalPrice" numeric not null,
  status text not null,
  "createdAt" timestamp with time zone not null default now(),
  "paymentMethod" text,
  "paymentUrl" text
);

-- Create Reviews Table
-- Note: userId references profiles(id) to allow easy joining in PostgREST
-- Since profiles.id is a FK to auth.users, this maintains referential integrity
create table reviews (
  id bigint generated by default as identity primary key,
  "spotId" bigint references spots(id) not null,
  "userId" uuid references profiles(id) not null,
  rating numeric not null,
  comment text,
  "createdAt" timestamp with time zone not null default now()
);

-- Enable Row Level Security (RLS)
alter table spots enable row level security;
alter table profiles enable row level security;
alter table bookings enable row level security;
alter table reviews enable row level security;

-- Policies

-- Spots are readable by everyone
create policy "Spots are viewable by everyone" on spots
  for select using (true);

-- Profiles are viewable by everyone (or just the user, depending on needs)
create policy "Profiles are viewable by everyone" on profiles
  for select using (true);

-- Users can insert their own profile (usually handled by trigger, but for updates)
create policy "Users can update own profile" on profiles
  for update using (auth.uid() = id);

-- Bookings: Users can see their own bookings
create policy "Users can view own bookings" on bookings
  for select using (auth.uid() = "userId");

-- Bookings: Users can insert their own bookings
create policy "Users can insert own bookings" on bookings
  for insert with check (auth.uid() = "userId");

-- Bookings: Users can update their own bookings
create policy "Users can update own bookings" on bookings
  for update using (auth.uid() = "userId");

-- Bookings: Users can delete their own bookings
create policy "Users can delete own bookings" on bookings
  for delete using (auth.uid() = "userId");

-- Reviews are readable by everyone
create policy "Reviews are viewable by everyone" on reviews
  for select using (true);

-- Users can insert their own reviews
create policy "Users can insert own reviews" on reviews
  for insert with check (auth.uid() = "userId");

```

## 4. Storage Setup

1. Go to **Storage** in the Supabase Dashboard.
2. Create a new bucket named `avatars`.
3. Make the bucket **Public**.
4. You might need to add a policy to allow authenticated users to upload files.
   - Policy Name: "Authenticated users can upload"
   - Target Role: Authenticated
   - Allowed Operations: INSERT (and UPDATE if needed)

## 5. Insert Seed Data (Optional)

You can insert some initial spots:

```sql
insert into spots (name, location, price, rating, "imageUrl", description, facilities)
values
('Glamping Lakeside', 'Situ Patenggang, Bandung', 1200000, 4.8, 'https://example.com/image1.jpg', 'Description here', 'Wifi,Breakfast,Bonfire'),
('Pine Forest Camp', 'Lembang, Bandung', 500000, 4.5, 'https://example.com/image2.jpg', 'Description here', 'Tent,BBQ');
```
